services:
  squid-proxy:
    image: ubuntu/squid:6.6-24.04_beta
    container_name: mcp-notion-squid
    networks:
      - proxy-net
    volumes:
      - ./proxy/squid.conf:/etc/squid/squid.conf:ro
      - ./log/proxy:/var/log/squid
    healthcheck:
      test: [ "CMD", "perl", "-e", "use IO::Socket::INET; exit(!(new IO::Socket::INET('localhost:3128')))" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  mcp-notion:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-notion
    networks:
      - playground-net
      - proxy-net
    environment:
      - NOTION_API_KEY=${NOTION_API_KEY}
      - HTTP_PROXY=http://squid-proxy:3128
      - HTTPS_PROXY=http://squid-proxy:3128
      - NODE_ENV=${NODE_ENV:-development}
    volumes:
      - ${HOST_WORKSPACE_PATH:-./workspace}:/workspace
    depends_on:
      squid-proxy:
        condition: service_healthy
    stdin_open: true
    tty: true

networks:
  playground-net:
    driver: bridge
    internal: true
  proxy-net:
    driver: bridge
