networks:
  playground-net:
    driver: bridge
    internal: true
  proxy-net:
    driver: bridge

services:
  squid-proxy:
    image: ubuntu/squid:6.6-24.04_beta
    volumes:
      - ./proxy/squid.conf:/etc/squid/squid.conf:ro
      - ./log/proxy:/var/log/squid
    healthcheck:
      test: [ "CMD", "perl", "-MHTTP::Tiny", "-e", "exit(HTTP::Tiny->new(proxy => 'http://localhost:3128')->get('http://healthcheck.invalid')->{headers}->{server} =~ /squid/i ? 0 : 1)" ]
      interval: 2s
      timeout: 10s
      retries: 10
    networks:
      - playground-net
      - proxy-net

  mcp-notion:
    build:
      context: .
      dockerfile: Dockerfile
    image: mcp-notion:latest
    environment:
      - NOTION_API_KEY=${NOTION_API_KEY}
      - HOST_WORKSPACE_PATH=${HOST_WORKSPACE_PATH:-/private/tmp}
      - HTTP_PROXY=http://squid-proxy:3128
      - HTTPS_PROXY=http://squid-proxy:3128
    volumes:
      - ${HOST_WORKSPACE_PATH:-./workspace}:/workspace
    depends_on:
      squid-proxy:
        condition: service_healthy
    networks:
      - playground-net
    stdin_open: true
    tty: false
